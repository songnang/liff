<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #fcf3eb; }
        #status { margin-bottom: 20px; color: #d35400; font-weight: bold; }
        iframe { width: 100%; height: 100vh; border: none; display: none; }
        button { padding: 10px 20px; background: #00c300; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; display: none; }
    </style>
</head>
<body>

    <div id="loading">
        <div style="font-size: 3em;">üîç</div>
        <p id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...</p>
        <button id="loginBtn" onclick="liff.login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE</button>
    </div>

    <!-- Iframe ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏° -->
    <iframe id="shop-frame"></iframe>

    <script>
        // üî¥ 1. ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const MY_LIFF_ID = "2009156099-XkhIO3sS"; 
        
        // üî¥ 2. ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Google Script Web App (/exec) ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        // .trim() ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏ú‡∏•‡∏≠‡∏ï‡∏¥‡∏î‡∏°‡∏≤
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwT7uP7g2-cet37Oha_ycNqkcQw5_NDsYRU5k0GGKNBd4oqGx12iZUUsyT_TlW18VU/exec".trim(); 

        async function main() {
            const status = document.getElementById('status');
            const frame = document.getElementById('shop-frame');
            const loading = document.getElementById('loading');
            const loginBtn = document.getElementById('loginBtn');

            try {
                // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF
                await liff.init({ liffId: MY_LIFF_ID });

                // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                if (!liff.isLoggedIn()) {
                    status.innerText = "‡∏ó‡πà‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE";
                    status.style.color = "red";
                    loginBtn.style.display = "inline-block"; // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÄ‡∏≠‡∏á
                    return;
                }

                status.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

                // 3. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                const profile = await liff.getProfile();
                const name = profile.displayName;
                const uid = profile.userId;
                
                // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡∏õ‡∏¥‡∏î Alert ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏´‡∏•‡∏•‡∏∑‡πà‡∏ô)
                console.log("LIFF Data:", name, uid); 

                status.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏á‡∏ô‡∏≤‡∏á...";

                // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Script
                // ‡πÉ‡∏ä‡πâ encodeURIComponent ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏≥‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏û‡∏±‡∏á
                const finalUrl = `${WEB_APP_URL}?name=${encodeURIComponent(name)}&lineid=${encodeURIComponent(name)}&uid=${encodeURIComponent(uid)}`;

                // 5. ‡πÇ‡∏´‡∏•‡∏î Iframe
                frame.src = finalUrl;
                
                frame.onload = () => {
                    loading.style.display = 'none';
                    frame.style.display = 'block';
                };

            } catch (err) {
                // ‡∏ñ‡πâ‡∏≤ Error ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ LIFF ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠ URL ‡∏ú‡∏¥‡∏î
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message + "\n(Code: " + err.code + ")");
                
                // Fallback: ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤
                status.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô)...";
                frame.src = WEB_APP_URL;
                setTimeout(() => {
                    loading.style.display = 'none';
                    frame.style.display = 'block';
                }, 1000);
            }
        }

        main();
    </script>
</body>
</html>
